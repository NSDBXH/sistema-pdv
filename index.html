<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sistema de Estoque</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100 text-gray-800">
  <!-- LOGIN -->
  <div id="loginScreen" class="flex items-center justify-center h-screen">
    <form id="loginForm" class="bg-white p-6 rounded shadow-md w-80">
      <h2 class="text-xl font-bold mb-4 text-center">Login</h2>
      <input type="text" id="username" placeholder="Usuário" required class="w-full border p-2 mb-4 rounded" />
      <input type="password" id="password" placeholder="Senha" required class="w-full border p-2 mb-4 rounded" />
      <button type="submit" class="w-full bg-blue-500 text-white p-2 rounded hover:bg-blue-600">Entrar</button>
      <p id="loginError" class="text-red-500 text-sm mt-2 hidden">Usuário ou senha inválidos.</p>
    </form>
  </div>

  <!-- APP -->
  <div id="app" class="p-4 hidden">
    <h1 class="text-2xl font-bold mb-4 text-center">Controle de Estoque</h1>
    
    <!-- Formulário -->
    <form id="productForm" class="grid md:grid-cols-5 sm:grid-cols-2 gap-2 mb-4">
      <input type="text" id="code" placeholder="Código" required class="border p-2 rounded" />
      <input type="text" id="name" placeholder="Nome" required class="border p-2 rounded" />
      <input type="number" id="quantity" placeholder="Qtd" required min="1" class="border p-2 rounded" />
      <input type="number" id="price" placeholder="Preço" required min="0.01" step="0.01" class="border p-2 rounded" />
      <input type="text" id="category" placeholder="Categoria" required class="border p-2 rounded" />
      <button type="submit" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 col-span-full">Cadastrar</button>
    </form>

    <!-- Tabela -->
    <div class="overflow-auto">
      <table class="w-full bg-white rounded shadow-md">
        <thead>
          <tr class="bg-gray-200">
            <th class="p-2">Código</th>
            <th class="p-2">Nome</th>
            <th class="p-2">Quantidade</th>
            <th class="p-2">Preço</th>
            <th class="p-2">Categoria</th>
            <th class="p-2">Ação</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Gráfico -->
    <div class="mt-6">
      <canvas id="productChart" height="100"></canvas>
    </div>
  </div>

  <script>
    const saveToStorage = (products) => {
      localStorage.setItem('products', JSON.stringify(products));
    };

    const loadFromStorage = () => {
      const data = localStorage.getItem('products');
      return data ? JSON.parse(data) : [];
    };

    let products = loadFromStorage();

    const renderProducts = () => {
      const tbody = document.querySelector("tbody");
      tbody.innerHTML = "";
      products.forEach((product, index) => {
        const row = `<tr>
          <td class="p-2 text-center">${product.code}</td>
          <td class="p-2 text-center">${product.name}</td>
          <td class="p-2 text-center">${product.quantity}</td>
          <td class="p-2 text-center">R$ ${parseFloat(product.price).toFixed(2)}</td>
          <td class="p-2 text-center">${product.category}</td>
          <td class="p-2 text-center">
            <button class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded delete-btn" data-index="${index}">Excluir</button>
          </td>
        </tr>`;
        tbody.innerHTML += row;
      });
      updateChart();
    };

    const updateChart = () => {
      const ctx = document.getElementById("productChart").getContext("2d");
      const categories = [...new Set(products.map(p => p.category))];
      const totals = categories.map(cat =>
        products.filter(p => p.category === cat).reduce((sum, p) => sum + parseInt(p.quantity), 0)
      );

      if (window.myChart) window.myChart.destroy();
      window.myChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: categories,
          datasets: [{
            label: 'Quantidade por Categoria',
            data: totals,
            backgroundColor: '#3B82F6'
          }]
        },
        options: {
          responsive: true,
          plugins: { legend: { display: false } }
        }
      });
    };

    document.getElementById("productForm").addEventListener("submit", function (e) {
      e.preventDefault();
      const code = document.getElementById("code").value.trim();
      const name = document.getElementById("name").value.trim();
      const quantity = parseInt(document.getElementById("quantity").value);
      const price = parseFloat(document.getElementById("price").value);
      const category = document.getElementById("category").value.trim();

      if (!code || !name || isNaN(quantity) || isNaN(price) || !category || quantity <= 0 || price <= 0) {
        alert("Preencha todos os campos corretamente.");
        return;
      }

      products.push({ code, name, quantity, price, category });
      saveToStorage(products);
      renderProducts();
      this.reset();
    });

    document.querySelector("tbody").addEventListener("click", function (e) {
      if (e.target.classList.contains("delete-btn")) {
        const index = e.target.getAttribute("data-index");
        products.splice(index, 1);
        saveToStorage(products);
        renderProducts();
      }
    });

    // Sistema de login simples e mais seguro (simulado)
    const loginForm = document.getElementById("loginForm");
    loginForm.addEventListener("submit", function (e) {
      e.preventDefault();
      const username = document.getElementById("username").value;
      const password = document.getElementById("password").value;

      const validUser = "admin";
      const validHash = btoa("1234"); // Senha simulada (criptografada base64)

      if (username === validUser && btoa(password) === validHash) {
        document.getElementById("loginScreen").classList.add("hidden");
        document.getElementById("app").classList.remove("hidden");
        renderProducts();
      } else {
        document.getElementById("loginError").classList.remove("hidden");
      }
    });
  </script>
</body>
</html>
